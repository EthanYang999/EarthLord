# EarthLord 内购系统开发记录

## 一、需求确认与方案设计

### 1.1 需求背景
为 EarthLord iOS 游戏实现消耗型内购系统，让玩家可以购买物资包。

### 1.2 确认的需求
| 项目 | 决策 |
|------|------|
| 产品范围 | 4 种消耗型物资包 |
| 商城入口 | 个人标签页内 |
| 邮箱入口 | 资源标签页「已购」替换为「邮箱」|
| 邮箱过期 | 永不过期 |
| 开箱动画 | 不需要 |
| 恢复购买 | 需要 |

### 1.3 产品定价
| 产品名称 | 产品 ID | 价格 |
|----------|---------|------|
| 幸存者补给包 | com.earthlord.supply.survivor | ¥6 |
| 探索者物资包 | com.earthlord.supply.explorer | ¥18 |
| 领主物资包 | com.earthlord.supply.lord | ¥30 |
| 末日霸主包 | com.earthlord.supply.overlord | ¥68 |

---

## 二、开发实施

### 2.1 Phase 1：数据库设置

在 Supabase 中创建 3 张数据表：

**表 1：supply_pack_definitions（物资包定义）**
- 存储 4 种物资包的配置信息
- 包含产品 ID、名称、价格、包含物品等

**表 2：purchase_records（购买记录）**
- 记录用户的每次购买
- 包含用户 ID、产品 ID、交易 ID、购买时间

**表 3：mailbox_items（邮箱物品）**
- 存储待领取的物资
- 包含用户 ID、物品列表、是否已领取

同时设置了 RLS（行级安全）策略，确保用户只能访问自己的数据。

### 2.2 Phase 2：数据模型

新建文件 `Models/IAPModels.swift`，包含：
- `SupplyPackTier` - 物资包等级枚举
- `DBSupplyPackDefinition` - 物资包定义模型
- `DBPurchaseRecord` - 购买记录模型
- `DBMailboxItem` - 邮箱物品模型
- `MailboxReward` - 奖励物品结构
- `IAPError` - 错误类型枚举
- `PurchaseState` - 购买状态枚举

### 2.3 Phase 3：内购管理器

新建文件 `Managers/IAPManager.swift`，实现：
- `startTransactionListener()` - 启动交易监听
- `loadProducts()` - 从 App Store 加载产品
- `loadSupplyPacks()` - 从数据库加载物资包定义
- `purchase()` - 执行购买
- `restorePurchases()` - 恢复购买
- `deliverPurchase()` - 发放物资到邮箱
- `loadMailbox()` - 加载邮箱
- `claimMailboxItem()` - 领取邮箱物品
- `claimAllMailboxItems()` - 一键领取全部

### 2.4 Phase 4：商城视图

新建文件：
- `Views/IAP/StoreView.swift` - 商城主页面
- `Views/IAP/SupplyPackCard.swift` - 物资包卡片组件

修改文件：
- `Views/Tabs/ProfileTabView.swift` - 添加商城入口按钮

### 2.5 Phase 5：邮箱视图

新建文件：
- `Views/IAP/MailboxView.swift` - 邮箱主页面
- `Views/IAP/MailboxItemRow.swift` - 邮箱物品行组件

修改文件：
- `Views/Tabs/ResourcesTabView.swift` - 将「已购」改为「邮箱」，替换为 MailboxView

### 2.6 Phase 6：应用初始化

修改文件 `EarthLordApp.swift`：
- 在 App 启动时调用 `IAPManager.shared.startTransactionListener()`
- 确保交易监听在应用启动时就开始工作

---

## 三、编译错误修复

### 3.1 错误 1：缺少 Combine 导入

**报错信息**：
```
Type 'IAPManager' does not conform to protocol 'ObservableObject'
Initializer 'init(wrappedValue:)' is not available due to missing import of defining module 'Combine'
```

**解决方案**：在 IAPManager.swift 顶部添加 `import Combine`

### 3.2 错误 2：字典类型冲突

**报错信息**：
```
Conflicting arguments to generic parameter 'some Encodable' ('[String : String]' vs. '[String : Bool]')
```

**原因**：更新邮箱状态时，字典混用了 Bool 和 String 类型
```swift
// 错误写法
.update(["is_claimed": true, "claimed_at": "2024-01-01"])
```

**解决方案**：创建专用结构体
```swift
struct UpdateMailboxItemClaim: Codable {
    let isClaimed: Bool
    let claimedAt: Date
}
```

---

## 四、App Store Connect 配置

### 4.1 配置银行账户和税务信息

1. 登录 https://appstoreconnect.apple.com
2. 点击「商务」→「协议、税务和银行业务」
3. 签署「付费应用程序」协议
4. 添加银行账户（需要银行联行号 CNAPS）
5. 填写税务信息

> 必须先完成这一步，否则无法创建内购产品！

### 4.2 创建内购产品

1. 进入「我的 App」→ 选择 EarthLord
2. 左侧菜单点击「App 内购买项目」
3. 点击「+」→ 选择「消耗型项目」
4. 填写信息：
   - 参考名称：幸存者补给包
   - 产品 ID：com.earthlord.supply.survivor
5. 设置价格等级（等级 1 = ¥6）
6. 添加本地化信息（显示名称、描述）
7. 保存

重复以上步骤创建 4 个产品：
| 产品 | 产品 ID | 价格等级 |
|------|---------|----------|
| 幸存者补给包 | com.earthlord.supply.survivor | 等级 1（¥6）|
| 探索者物资包 | com.earthlord.supply.explorer | 等级 3（¥18）|
| 领主物资包 | com.earthlord.supply.lord | 等级 5（¥30）|
| 末日霸主包 | com.earthlord.supply.overlord | 等级 11（¥68）|

### 4.3 创建沙盒测试账号

1. 在 App Store Connect 点击「用户和访问」
2. 点击顶部「沙盒」标签
3. 点击「测试员」旁边的「+」
4. 填写测试账号信息（使用未注册过的邮箱）
5. 创建完成

### 4.4 iPhone 配置沙盒账号

1. 打开 iPhone「设置」
2. 滑到最底部，点击「开发者」
3. 点击「沙盒 Apple 账户」
4. 登录刚才创建的沙盒测试账号

> 注意：不要在「设置 → Apple ID」里登录沙盒账号！

---

## 五、测试与问题排查

### 5.1 问题：购买按钮点不动

**原因分析**：
- 按钮有禁用条件：当 App Store 没有返回产品时，按钮禁用
- App Store Connect 未配置产品前，`loadProducts()` 返回空数组

**解决**：配置好 App Store Connect 产品后，按钮自动可用

### 5.2 问题：模拟器无法测试

**原因**：模拟器没有 App Store 账号系统，无法进行沙盒购买

**解决**：必须使用真机 + 沙盒账号测试

### 5.3 问题：购买成功但邮箱没收到物资

**排查过程**：
1. 检查 IAPManager 代码逻辑 - 正常
2. 检查数据库 RLS 策略 - 发现问题！

**原因**：只创建了 SELECT 和 UPDATE 策略，缺少 INSERT 策略

**解决方案**：添加 INSERT 策略
```sql
CREATE POLICY "users_insert_own_purchases" ON purchase_records
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "users_insert_own_mailbox" ON mailbox_items
    FOR INSERT WITH CHECK (auth.uid() = user_id);
```

执行后，购买流程完整运行。

---

## 六、文件清单

### 新建文件（6 个）
| 文件路径 | 说明 |
|----------|------|
| Models/IAPModels.swift | 内购数据模型 |
| Managers/IAPManager.swift | StoreKit 2 管理器 |
| Views/IAP/StoreView.swift | 商城页面 |
| Views/IAP/SupplyPackCard.swift | 物资包卡片 |
| Views/IAP/MailboxView.swift | 邮箱页面 |
| Views/IAP/MailboxItemRow.swift | 邮箱物品行 |

### 修改文件（3 个）
| 文件路径 | 修改内容 |
|----------|----------|
| Views/Tabs/ProfileTabView.swift | 添加商城入口 |
| Views/Tabs/ResourcesTabView.swift | 已购→邮箱 |
| EarthLordApp.swift | 初始化 IAPManager |

---

## 七、完整购买流程

```
用户进入商城
    ↓
点击物资包价格按钮
    ↓
系统弹出购买确认（App Store 原生界面）
    ↓
用户确认支付
    ↓
StoreKit 处理交易
    ↓
IAPManager 收到交易成功通知
    ↓
写入购买记录到 purchase_records 表
    ↓
创建邮箱物品到 mailbox_items 表
    ↓
用户进入「资源」→「邮箱」
    ↓
点击「领取」按钮
    ↓
物品添加到背包（inventory_items 表）
    ↓
邮箱物品标记为已领取
```

---

## 八、总结

| 阶段 | 工作内容 |
|------|----------|
| 方案设计 | 确认需求、产品定价、技术方案 |
| 数据库 | 3 张表 + RLS 策略 |
| Swift 开发 | 6 个新文件 + 3 个修改文件 |
| 后台配置 | 银行税务 + 4 个产品 + 沙盒账号 |
| 问题修复 | 编译错误 + RLS 权限问题 |

开发完成时间：约 2 小时
